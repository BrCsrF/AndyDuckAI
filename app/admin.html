<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AndyDuckAI Admin ü¶Ü</title>
  <style>
    :root {
      --primary: #4D96FF;
      --success: #6BCB77;
      --warning: #FFD93D;
      --danger: #E74C3C;
      --bg: #F8F9FA;
      --card: #FFFFFF;
      --text: #2D3436;
      --text-light: #636E72;
      --border: #DEE2E6;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-screen.hidden { display: none; }
    
    .login-box {
      background: var(--card);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    
    .login-box h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .login-box p {
      color: var(--text-light);
      margin-bottom: 30px;
    }
    
    .login-box input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      text-align: center;
      letter-spacing: 8px;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .login-box button {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .login-box button:hover {
      background: #3D7BD9;
    }
    
    .error-msg {
      color: var(--danger);
      margin-top: 15px;
      display: none;
    }
    
    /* Admin Dashboard */
    .dashboard {
      display: none;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard.active { display: block; }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    header h1 {
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #3D7BD9;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }
    
    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--card);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: bold;
      color: var(--primary);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 12px 24px;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .tab:hover {
      border-color: var(--primary);
    }
    
    .tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Tables */
    .table-container {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .table-header h2 {
      font-size: 18px;
    }
    
    .search-box {
      padding: 10px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      width: 250px;
    }
    
    .search-box:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background: var(--bg);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      color: var(--text-light);
    }
    
    tr:hover {
      background: var(--bg);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #E8F5E9;
      color: #2E7D32;
    }
    
    .badge-warning {
      background: #FFF8E1;
      color: #F57F17;
    }
    
    .badge-danger {
      background: #FFEBEE;
      color: #C62828;
    }
    
    .badge-info {
      background: #E3F2FD;
      color: #1565C0;
    }
    
    .fail-tries {
      font-family: monospace;
      font-size: 13px;
      color: var(--danger);
    }
    
    .ai-judge {
      font-size: 13px;
      color: var(--text-light);
      max-width: 250px;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .table-container {
        overflow-x: auto;
      }
      
      table {
        min-width: 800px;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="login-screen">
    <div class="login-box">
      <h1>ü¶Ü AndyDuckAI Admin</h1>
      <p>Enter PIN to access admin panel</p>
      <input type="password" id="admin-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric">
      <button id="btn-login">Login</button>
      <p class="error-msg" id="login-error">Invalid PIN</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <header>
      <h1>ü¶Ü AndyDuckAI Admin</h1>
      <div style="display:flex; gap:10px; align-items:center;">
        <select class="filter-select" id="global-year-filter" style="font-size:16px; padding:10px;">
          <option value="">All</option>
          <option value="11401" selected>114‰∏ä</option>
          <option value="11402">114‰∏ã</option>
          <option value="11301">113‰∏ä</option>
          <option value="11302">113‰∏ã</option>
        </select>
        <select class="filter-select" id="global-branch-filter" style="font-size:16px; padding:10px;">
          <option value="">All Branches</option>
          <option value="MQ">MQ Ê∞ëÊ¨ä</option>
          <option value="MS">MS Ê∞ëÁîü</option>
          <option value="MT">MT Ê∞ëÊóè</option>
          <option value="JK">JK ÂÅ•Â∫∑</option>
          <option value="YS">YS Âª∂Â£Ω</option>
          <option value="XS">XS Ë•øÊùæ</option>
        </select>
        <button class="btn btn-success" id="btn-export">üì• Export CSV</button>
        <button class="btn btn-outline" id="btn-refresh">üîÑ Refresh</button>
        <button class="btn btn-danger" id="btn-logout">Logout</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Students</h3>
        <div class="value" id="stat-students">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Attempts</h3>
        <div class="value" id="stat-attempts">0</div>
      </div>
      <div class="stat-card">
        <h3>Words Tracked</h3>
        <div class="value" id="stat-words">0</div>
      </div>
      <div class="stat-card">
        <h3>Avg Success Rate</h3>
        <div class="value" id="stat-success">0%</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="attempts">Word Attempts</div>
      <div class="tab" data-tab="students">Students</div>
      <div class="tab" data-tab="photos">üì∑ Login Photos</div>
    </div>

    <!-- Word Attempts Table -->
    <div class="table-container" id="tab-attempts">
      <div class="table-header">
        <h2>Word Attempt Records</h2>
        <input type="text" class="search-box" id="search-attempts" placeholder="Search...">
      </div>
      <div class="filters">
        <select class="filter-select" id="filter-student">
          <option value="">All Students</option>
        </select>
        <select class="filter-select" id="filter-level">
          <option value="">All Levels</option>
          <option value="Starters">Starters</option>
          <option value="Movers">Movers</option>
          <option value="Flyers">Flyers</option>
          <option value="SuperFlyers">SuperFlyers</option>
        </select>
        <select class="filter-select" id="filter-set">
          <option value="">All Sets</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Branch</th>
            <th>Year</th>
            <th>Name</th>
            <th>Level</th>
            <th>Set</th>
            <th>Word</th>
            <th>Fail / Total</th>
            <th>Failed Attempts</th>
            <th>AI Analysis</th>
          </tr>
        </thead>
        <tbody id="attempts-tbody">
        </tbody>
      </table>
      <div class="empty-state" id="attempts-empty" style="display:none;">
        <div class="icon">üìù</div>
        <p>No word attempts recorded yet</p>
      </div>
    </div>

    <!-- Students Table -->
    <div class="table-container" id="tab-students" style="display:none;">
      <div class="table-header">
        <h2>Student List</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="text" class="search-box" id="search-students" placeholder="Search...">
          <button class="btn btn-primary" id="btn-add-student">+ Add</button>
          <button class="btn btn-outline" id="btn-import-students">üì§ Import</button>
        </div>
      </div>
      
      <!-- Add Student Form (hidden by default) -->
      <div id="add-student-form" style="display:none; padding:20px; border-bottom:1px solid var(--border); background:var(--bg);">
        <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
          <select id="new-student-branch" class="filter-select">
            <option value="">Branch</option>
            <option value="MQ">MQ Ê∞ëÊ¨ä</option>
            <option value="MS">MS Ê∞ëÁîü</option>
            <option value="MT">MT Ê∞ëÊóè</option>
            <option value="JK">JK ÂÅ•Â∫∑</option>
            <option value="YS">YS Âª∂Â£Ω</option>
            <option value="XS">XS Ë•øÊùæ</option>
          </select>
          <select id="new-student-year" class="filter-select">
            <option value="">Year</option>
            <option value="11401" selected>114‰∏ä</option>
            <option value="11402">114‰∏ã</option>
            <option value="11301">113‰∏ä</option>
            <option value="11302">113‰∏ã</option>
          </select>
          <select id="new-student-level" class="filter-select">
            <option value="">Level</option>
            <option value="Starters">Starters</option>
            <option value="Movers">Movers</option>
            <option value="Flyers">Flyers</option>
            <option value="SuperFlyers">SuperFlyers</option>
          </select>
          <input type="text" id="new-student-name" placeholder="Name (A-Z)" class="search-box" style="width:150px;" maxlength="20" pattern="[A-Za-z]+">
          <button class="btn btn-success" id="btn-save-student">Save</button>
          <button class="btn btn-outline" id="btn-cancel-student">Cancel</button>
        </div>
        <p id="add-student-error" style="color:var(--danger); margin-top:10px; display:none;"></p>
      </div>
      
      <!-- Import Form (hidden by default) -->
      <div id="import-form" style="display:none; padding:20px; border-bottom:1px solid var(--border); background:var(--bg);">
        <h3 style="margin-bottom:15px;">üì§ Import Students from CSV</h3>
        <p style="margin-bottom:10px; color:var(--text-light);">CSV format: <strong>Branch, StudyYear, Level, Name</strong></p>
        <p style="margin-bottom:15px; font-size:12px; color:var(--text-light);">
          Example:<br>
          MQ,11401,Starters,ChrisChen<br>
          MS,11401,Movers,TommyLee
        </p>
        
        <div style="margin-bottom:15px;">
          <input type="file" id="import-file" accept=".csv,.txt" style="display:none;">
          <button class="btn btn-outline" id="btn-choose-file">üìÅ Choose CSV File</button>
          <span id="file-name" style="margin-left:10px; color:var(--text-light);"></span>
        </div>
        
        <p style="margin-bottom:10px; color:var(--text-light);">Or paste CSV data:</p>
        <textarea id="import-csv" style="width:100%; height:120px; padding:10px; font-family:monospace; border:2px solid var(--border); border-radius:8px;" placeholder="MQ,11401,Starters,ChrisChen
MS,11401,Movers,TommyLee
JK,11402,Flyers,MaryWang"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button class="btn btn-success" id="btn-do-import">Import</button>
          <button class="btn btn-outline" id="btn-cancel-import">Cancel</button>
        </div>
        
        <div id="import-result" style="margin-top:15px; display:none; padding:15px; border-radius:8px; background:var(--card);">
          <p id="import-summary" style="font-weight:bold;"></p>
          <div id="import-errors" style="margin-top:10px; font-size:13px; color:var(--danger); max-height:150px; overflow-y:auto;"></div>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>Branch</th>
            <th>Year</th>
            <th>Name</th>
            <th>Level</th>
            <th>Created</th>
            <th>Last Active</th>
          </tr>
        </thead>
        <tbody id="students-tbody">
        </tbody>
      </table>
      <div class="empty-state" id="students-empty" style="display:none;">
        <div class="icon">üë®‚Äçüéì</div>
        <p>No students registered yet</p>
      </div>
    </div>
  </div>

    <!-- Photos Grid -->
    <div class="table-container" id="tab-photos" style="display:none;">
      <div class="table-header">
        <h2>Login Photos</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <select class="filter-select" id="filter-photo-student">
            <option value="">All Students</option>
          </select>
          <button class="btn btn-outline" id="btn-refresh-photos">üîÑ Refresh</button>
        </div>
      </div>
      <div class="photo-grid" id="photo-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px; padding:20px;">
        <!-- Photos will be populated here -->
      </div>
      <div class="empty-state" id="photos-empty" style="display:none;">
        <div class="icon">üì∑</div>
        <p>No login photos yet</p>
      </div>
    </div>

    <style>
      .photo-card {
        background: var(--card);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .photo-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
      }
      .photo-card .photo-info {
        padding: 12px;
      }
      .photo-card .photo-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 4px;
      }
      .photo-card .photo-time {
        font-size: 12px;
        color: var(--text-light);
      }
    </style>

  <script>
    let accessPin = '';
    let studentsData = [];
    let attemptsData = [];
    let photosData = [];

    // Login
    document.getElementById('btn-login').addEventListener('click', login);
    document.getElementById('admin-pin').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    async function login() {
      const pin = document.getElementById('admin-pin').value;
      const errorEl = document.getElementById('login-error');
      
      try {
        const res = await fetch('/api/verify-pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pin })
        });
        
        if (res.ok) {
          accessPin = pin;
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('dashboard').classList.add('active');
          loadData();
        } else {
          errorEl.style.display = 'block';
          document.getElementById('admin-pin').value = '';
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
      }
    }

    // Logout
    document.getElementById('btn-logout').addEventListener('click', () => {
      accessPin = '';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('admin-pin').value = '';
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabName = tab.dataset.tab;
        document.getElementById('tab-attempts').style.display = tabName === 'attempts' ? 'block' : 'none';
        document.getElementById('tab-students').style.display = tabName === 'students' ? 'block' : 'none';
        document.getElementById('tab-photos').style.display = tabName === 'photos' ? 'block' : 'none';
        
        if (tabName === 'photos') {
          loadPhotos();
        }
      });
    });

    // API helper
    async function apiCall(url) {
      const res = await fetch(url, {
        headers: { 'X-Access-Pin': accessPin }
      });
      return res.json();
    }

    // Get current filters
    function getCurrentBranch() {
      return document.getElementById('global-branch-filter').value;
    }
    function getCurrentYear() {
      return document.getElementById('global-year-filter').value;
    }

    // Load data
    async function loadData() {
      try {
        const branch = getCurrentBranch();
        const year = getCurrentYear();
        let query = [];
        if (branch) query.push(`branch=${branch}`);
        if (year) query.push(`studyYear=${year}`);
        const queryStr = query.length > 0 ? '?' + query.join('&') : '';
        
        const [studentsRes, attemptsRes] = await Promise.all([
          apiCall('/api/students' + queryStr),
          apiCall('/api/word-attempts' + queryStr)
        ]);
        
        studentsData = studentsRes.students || [];
        attemptsData = attemptsRes.attempts || [];
        
        updateStats();
        renderStudents();
        renderAttempts();
        updateFilters();
      } catch (e) {
        console.error('Failed to load data:', e);
      }
    }

    // Filter changes
    document.getElementById('global-branch-filter').addEventListener('change', loadData);
    document.getElementById('global-year-filter').addEventListener('change', loadData);

    // Update stats
    function updateStats() {
      document.getElementById('stat-students').textContent = studentsData.length;
      
      const totalAttempts = attemptsData.reduce((sum, a) => sum + a.totalTimes, 0);
      document.getElementById('stat-attempts').textContent = totalAttempts;
      
      document.getElementById('stat-words').textContent = attemptsData.length;
      
      const totalFails = attemptsData.reduce((sum, a) => sum + a.failTimes, 0);
      const successRate = totalAttempts > 0 ? Math.round(((totalAttempts - totalFails) / totalAttempts) * 100) : 0;
      document.getElementById('stat-success').textContent = successRate + '%';
    }

    // Render students table
    function renderStudents(filter = '') {
      const tbody = document.getElementById('students-tbody');
      const empty = document.getElementById('students-empty');
      
      let filtered = studentsData;
      if (filter) {
        filtered = filtered.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      tbody.innerHTML = filtered.map(s => `
        <tr>
          <td><span class="badge badge-warning">${s.branch || '-'}</span></td>
          <td>${s.studyYear || '-'}</td>
          <td><strong>${s.name}</strong></td>
          <td><span class="badge badge-info">${s.level}</span></td>
          <td>${formatDate(s.createdAt)}</td>
          <td>${formatDate(s.lastActive)}</td>
        </tr>
      `).join('');
    }

    // Render attempts table
    function renderAttempts(filters = {}) {
      const tbody = document.getElementById('attempts-tbody');
      const empty = document.getElementById('attempts-empty');
      
      let filtered = attemptsData;
      
      if (filters.search) {
        const q = filters.search.toLowerCase();
        filtered = filtered.filter(a => 
          a.name.toLowerCase().includes(q) || 
          a.word.toLowerCase().includes(q)
        );
      }
      if (filters.student) {
        filtered = filtered.filter(a => a.name === filters.student);
      }
      if (filters.level) {
        filtered = filtered.filter(a => a.level === filters.level);
      }
      if (filters.set) {
        filtered = filtered.filter(a => a.set === parseInt(filters.set));
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      tbody.innerHTML = filtered.map(a => {
        const rate = a.totalTimes > 0 ? Math.round((a.failTimes / a.totalTimes) * 100) : 0;
        let badgeClass = 'badge-success';
        if (rate > 50) badgeClass = 'badge-danger';
        else if (rate > 20) badgeClass = 'badge-warning';
        
        return `
          <tr>
            <td><span class="badge badge-warning">${a.branch || '-'}</span></td>
            <td>${a.studyYear || '-'}</td>
            <td><strong>${a.name}</strong></td>
            <td><span class="badge badge-info">${a.level}</span></td>
            <td>Set ${a.set}</td>
            <td><strong>${a.word}</strong></td>
            <td><span class="badge ${badgeClass}">${a.failTimes} / ${a.totalTimes}</span></td>
            <td class="fail-tries">${a.failTries.join(', ') || '-'}</td>
            <td class="ai-judge">${a.aiJudge || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    // Update filter dropdowns
    function updateFilters() {
      // Student filter
      const studentFilter = document.getElementById('filter-student');
      const students = [...new Set(attemptsData.map(a => a.name))];
      studentFilter.innerHTML = '<option value="">All Students</option>' + 
        students.map(s => `<option value="${s}">${s}</option>`).join('');
      
      // Set filter
      const setFilter = document.getElementById('filter-set');
      const sets = [...new Set(attemptsData.map(a => a.set))].sort((a, b) => a - b);
      setFilter.innerHTML = '<option value="">All Sets</option>' + 
        sets.map(s => `<option value="${s}">Set ${s}</option>`).join('');
    }

    // Filter event listeners
    document.getElementById('search-attempts').addEventListener('input', applyFilters);
    document.getElementById('filter-student').addEventListener('change', applyFilters);
    document.getElementById('filter-level').addEventListener('change', applyFilters);
    document.getElementById('filter-set').addEventListener('change', applyFilters);
    document.getElementById('search-students').addEventListener('input', (e) => {
      renderStudents(e.target.value);
    });

    function applyFilters() {
      renderAttempts({
        search: document.getElementById('search-attempts').value,
        student: document.getElementById('filter-student').value,
        level: document.getElementById('filter-level').value,
        set: document.getElementById('filter-set').value
      });
    }

    // Export CSV
    document.getElementById('btn-export').addEventListener('click', () => {
      const branch = getCurrentBranch();
      const year = getCurrentYear();
      let params = [`pin=${accessPin}`];
      if (branch) params.push(`branch=${branch}`);
      if (year) params.push(`studyYear=${year}`);
      window.open('/api/word-attempts/export?' + params.join('&'), '_blank');
    });

    // Refresh
    document.getElementById('btn-refresh').addEventListener('click', loadData);

    // Photos
    async function loadPhotos() {
      try {
        const branch = getCurrentBranch();
        const branchQuery = branch ? `?branch=${branch}` : '';
        const res = await fetch('/api/photos' + branchQuery, {
          headers: { 'X-Access-Pin': accessPin }
        });
        const data = await res.json();
        photosData = data.photos || [];
        renderPhotos();
        updatePhotoFilters();
      } catch (e) {
        console.error('Failed to load photos:', e);
      }
    }

    function renderPhotos(studentFilter = '') {
      const grid = document.getElementById('photo-grid');
      const empty = document.getElementById('photos-empty');
      
      let filtered = photosData;
      if (studentFilter) {
        filtered = filtered.filter(p => p.student === studentFilter);
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      grid.innerHTML = filtered.map(p => `
        <div class="photo-card">
          <img src="/api/photos/${p.filename}?pin=${accessPin}" alt="${p.student}" loading="lazy">
          <div class="photo-info">
            <div class="photo-name">${p.branch ? p.branch + ' - ' : ''}${p.student}</div>
            <div class="photo-time">${formatPhotoTime(p.filename)}</div>
          </div>
        </div>
      `).join('');
    }

    function updatePhotoFilters() {
      const filter = document.getElementById('filter-photo-student');
      const students = [...new Set(photosData.map(p => p.student))];
      filter.innerHTML = '<option value="">All Students</option>' + 
        students.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function formatPhotoTime(filename) {
      // Extract timestamp from filename: Name_2026-02-07T11-30-00-000Z.jpg
      const match = filename.match(/_(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})-(\d{2})/);
      if (match) {
        return `${match[1]} ${match[2]}:${match[3]}:${match[4]}`;
      }
      return '';
    }

    document.getElementById('filter-photo-student').addEventListener('change', (e) => {
      renderPhotos(e.target.value);
    });

    document.getElementById('btn-refresh-photos').addEventListener('click', loadPhotos);

    // Utils
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Add Student
    document.getElementById('btn-add-student').addEventListener('click', () => {
      document.getElementById('add-student-form').style.display = 'block';
      document.getElementById('new-student-name').focus();
    });

    document.getElementById('btn-cancel-student').addEventListener('click', () => {
      document.getElementById('add-student-form').style.display = 'none';
      document.getElementById('new-student-name').value = '';
      document.getElementById('new-student-level').value = '';
      document.getElementById('add-student-error').style.display = 'none';
    });

    document.getElementById('btn-save-student').addEventListener('click', saveNewStudent);
    document.getElementById('new-student-name').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') saveNewStudent();
    });

    // Only allow A-Z in name input
    document.getElementById('new-student-name').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^A-Za-z]/g, '').substring(0, 20);
    });

    async function saveNewStudent() {
      const branch = document.getElementById('new-student-branch').value;
      const studyYear = document.getElementById('new-student-year').value;
      const level = document.getElementById('new-student-level').value;
      const name = document.getElementById('new-student-name').value.trim();
      const errorEl = document.getElementById('add-student-error');

      if (!branch) {
        errorEl.textContent = 'Please select a branch';
        errorEl.style.display = 'block';
        return;
      }

      if (!studyYear) {
        errorEl.textContent = 'Please select a study year';
        errorEl.style.display = 'block';
        return;
      }

      if (!level) {
        errorEl.textContent = 'Please select a level';
        errorEl.style.display = 'block';
        return;
      }

      if (!name || name.length === 0) {
        errorEl.textContent = 'Please enter a name (A-Z only)';
        errorEl.style.display = 'block';
        return;
      }

      // Check if already exists (branch + year + level + name)
      if (studentsData.find(s => 
        s.name.toLowerCase() === name.toLowerCase() && 
        s.branch === branch && 
        s.studyYear === parseInt(studyYear) &&
        s.level === level
      )) {
        errorEl.textContent = 'Student already exists!';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/students', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Pin': accessPin
          },
          body: JSON.stringify({ name, level, branch, studyYear })
        });

        if (res.ok) {
          document.getElementById('add-student-form').style.display = 'none';
          document.getElementById('new-student-branch').value = '';
          document.getElementById('new-student-year').value = '114';
          document.getElementById('new-student-level').value = '';
          document.getElementById('new-student-name').value = '';
          errorEl.style.display = 'none';
          loadData(); // Refresh
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Failed to add student';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
      }
    }

    // Import students
    document.getElementById('btn-import-students').addEventListener('click', () => {
      document.getElementById('import-form').style.display = 'block';
      document.getElementById('import-result').style.display = 'none';
    });

    document.getElementById('btn-cancel-import').addEventListener('click', () => {
      document.getElementById('import-form').style.display = 'none';
      document.getElementById('import-csv').value = '';
      document.getElementById('import-file').value = '';
      document.getElementById('file-name').textContent = '';
      document.getElementById('import-result').style.display = 'none';
    });

    // File chooser
    document.getElementById('btn-choose-file').addEventListener('click', () => {
      document.getElementById('import-file').click();
    });

    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('file-name').textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('import-csv').value = e.target.result;
        };
        reader.readAsText(file);
      }
    });

    document.getElementById('btn-do-import').addEventListener('click', async () => {
      const csv = document.getElementById('import-csv').value.trim();
      const resultEl = document.getElementById('import-result');
      const summaryEl = document.getElementById('import-summary');
      const errorsEl = document.getElementById('import-errors');
      
      if (!csv) {
        summaryEl.textContent = '‚ùå Please select a file or paste CSV data';
        summaryEl.style.color = 'var(--danger)';
        errorsEl.innerHTML = '';
        resultEl.style.display = 'block';
        return;
      }

      const lines = csv.split('\n').filter(l => l.trim() && !l.startsWith('#'));
      const students = [];
      const parseErrors = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        // Skip header row if present
        if (i === 0 && line.toLowerCase().includes('branch')) continue;
        
        const parts = line.split(',').map(p => p.trim());
        
        // Expected format: Branch, StudyYear, Level, Name
        if (parts.length < 4) {
          parseErrors.push(`Line ${i+1}: Invalid format - expected 4 columns (Branch,Year,Level,Name), got ${parts.length}`);
          continue;
        }
        
        students.push({
          branch: parts[0].toUpperCase(),
          studyYear: parts[1],
          level: parts[2],
          name: parts[3]
        });
      }

      if (students.length === 0) {
        summaryEl.textContent = '‚ùå No valid data found';
        summaryEl.style.color = 'var(--danger)';
        errorsEl.innerHTML = parseErrors.map(e => `<div>${e}</div>`).join('');
        resultEl.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/students/import', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Pin': accessPin
          },
          body: JSON.stringify({ students })
        });

        const data = await res.json();
        if (res.ok) {
          const allErrors = [...parseErrors, ...data.errors];
          if (allErrors.length === 0) {
            summaryEl.textContent = `‚úÖ Success! Added: ${data.added}, Updated: ${data.updated}`;
            summaryEl.style.color = 'var(--success)';
          } else {
            summaryEl.textContent = `‚ö†Ô∏è Added: ${data.added}, Updated: ${data.updated}, Errors: ${allErrors.length}`;
            summaryEl.style.color = 'var(--warning)';
          }
          errorsEl.innerHTML = allErrors.map(e => `<div>‚Ä¢ ${e}</div>`).join('');
          resultEl.style.display = 'block';
          loadData();
        } else {
          summaryEl.textContent = data.error || 'Import failed';
          summaryEl.style.color = 'var(--danger)';
          errorsEl.innerHTML = '';
          resultEl.style.display = 'block';
        }
      } catch (e) {
        summaryEl.textContent = 'Connection error';
        summaryEl.style.color = 'var(--danger)';
        errorsEl.innerHTML = '';
        resultEl.style.display = 'block';
      }
    });
  </script>
</body>
</html>
